<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verify - sami.is-a.dev</title>
<style>
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif}
  body{display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f8f9fa,#e3f2fd);cursor:auto}
  .box{background:rgba(255,255,255,0.98);padding:24px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.12);text-align:center;max-width:540px}
  h1{margin:0 0 8px;font-size:20px}
  p{margin:0 0 14px;color:#444}
  #recaptcha-placeholder{min-height:78px}
  #debug{font-size:12px;color:#666;margin-top:10px;text-align:left;white-space:pre-wrap;max-height:120px;overflow:auto}
</style>
</head>
<body>
  <div class="box">
    <h1>Verify you're human</h1>
    <p id="status">Preparing verification...</p>
    <div id="recaptcha-placeholder"></div>
    <div id="debug"></div>
  </div>

<script>
/* CONFIG */
const SITE = location.origin.replace(/\/$/,''); // e.g. https://sami.is-a.dev
const MAIN = SITE + '/?verified=1';             // will append ts param later
const COOKIE_NAME = 'sami_verified';
const COOKIE_DAYS = 7;

/* helpers */
function debug(msg){
  console.debug('[recaptcha] ' + msg);
  document.getElementById('status').textContent = msg;
  const el = document.getElementById('debug');
  el.textContent = (el.textContent ? el.textContent + '\n' : '') + '[debug] ' + msg;
}
function setCookie(name,value,days){
  const d=new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
  const expires='expires=' + d.toUTCString();
  // if your site is HTTPS you may add ;Secure
  document.cookie = `${name}=${value};${expires};path=/;SameSite=Lax`;
}
function getCookie(name){
  const pairs=document.cookie.split(';').map(s=>s.trim());
  for(const p of pairs) if(p.startsWith(name + '=')) return p.split('=')[1];
  return null;
}

/* quick safety: if cookie already set, go home */
if(getCookie(COOKIE_NAME) === 'true'){
  debug('cookie found -> already verified. redirecting to main...');
  // add timestamp to avoid caching issues
  window.location.replace(MAIN + '&ts=' + Date.now());
} else {
  debug('not verified -> loading reCAPTCHA script...');
  // load grecaptcha script dynamically
  const s=document.createElement('script');
  s.src='https://www.google.com/recaptcha/api.js?onload=__onRecaptchaLoad&render=explicit';
  s.async=true; s.defer=true;
  s.onerror = () => debug('Failed loading recaptcha script (network or blocked).');
  document.head.appendChild(s);

  // called by google when lib loads
  window.__onRecaptchaLoad = function(){
    debug('reCAPTCHA lib loaded, rendering widget...');
    const holder = document.getElementById('recaptcha-placeholder');
    holder.innerHTML = '';
    const wrapper = document.createElement('div'); wrapper.id = 'gwidget';
    holder.appendChild(wrapper);

    try {
      window.grecaptcha.render('gwidget', {
        sitekey: '6LcRBhAsAAAAACatryubAg_7jPQPb5i_tcAIoCa-', // your key
        callback: onRecaptchaSuccess,
        theme: 'light'
      });
      debug('Widget rendered — waiting for user to solve captcha.');
    } catch (err) {
      console.error(err);
      debug('Error rendering widget — check site key & domain match in Google console.');
    }
  };

  // success handler
  function onRecaptchaSuccess(token){
    debug('CAPTCHA solved; token length=' + (token ? token.length : 0));
    // store BOTH cookie and localStorage as redundancy
    try {
      setCookie(COOKIE_NAME,'true', COOKIE_DAYS);
      localStorage.setItem(COOKIE_NAME, 'true');
      debug('Cookie + localStorage written.');
    } catch(e){
      console.warn('Failed to write storage:', e);
      debug('Failed to write storage; proceeding to redirect anyway.');
    }

    // redirect to main with timestamp so index sees verified immediately
    const dest = MAIN + '&ts=' + Date.now();
    debug('Redirecting to: ' + dest);
    // replace prevents back-button returning to recaptcha
    window.location.replace(dest);
  }

  // expose for debugging in console
  window.onRecaptchaSuccess = onRecaptchaSuccess;
}
</script>
</body>
</html>
