<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify — Sami-S.dev</title>

  <!-- PUBLIC reCAPTCHA v3 SITE KEY (replace if different) -->
  <script>
    const RECAPTCHA_SITE_KEY = "6Lep_HYsAAAAAAerNedHFNuVPuaF5JpH-dFxF6ft";
    const VERIFICATION_TTL_MS = 24 * 60 * 60 * 1000; // verification lifetime (ms)
  </script>

  <!-- load v3 (render=sitekey optional) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Lep_HYsAAAAAAerNedHFNuVPuaF5JpH-dFxF6ft" async defer></script>

  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Arial;background:#071428;color:#e6eef6;display:flex;align-items:center;justify-content:center}
    .card{background:#0b1220;padding:28px;border-radius:12px;max-width:420px;text-align:center;box-shadow:0 8px 40px rgba(2,6,23,.6)}
    .muted{color:#9aa4b2;font-size:14px}
    button{margin-top:14px;padding:10px 14px;border-radius:10px;border:0;background:#6ee7b7;color:#042028;font-weight:700;cursor:pointer}
    .error{color:#ff8b8b;margin-top:12px}
  </style>
</head>
<body>
  <div class="card" id="app">
    <h2>Human verification</h2>
    <p class="muted" id="status">Performing a quick invisible check — this usually takes 1–3 seconds.</p>
    <div id="actions" style="display:none">
      <button id="tryBtn">Try again</button>
    </div>
    <div id="err" class="error" style="display:none"></div>
  </div>

  <script>
  (function(){
    const STORAGE_KEY = 'captcha_ok_v3';
    const ATTEMPTS_KEY = 'captcha_attempts_v3';
    const MAX_ATTEMPTS = 5;

    const statusEl = document.getElementById('status');
    const actionsEl = document.getElementById('actions');
    const tryBtn = document.getElementById('tryBtn');
    const errEl = document.getElementById('err');

    function setVerified(token) {
      const obj = { ts: Date.now(), token: token || null };
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    }
    function clearAttempts(){ sessionStorage.removeItem(ATTEMPTS_KEY); }
    function getAttempts(){ return parseInt(sessionStorage.getItem(ATTEMPTS_KEY] || '0', 10) || 0; } // safe parse
    function incAttempts(){ const n = (parseInt(sessionStorage.getItem(ATTEMPTS_KEY] || '0', 10) || 0) + 1; sessionStorage.setItem(ATTEMPTS_KEY, String(n)); return n; }

    // Wait for grecaptcha to be available (timeout)
    function waitForGrecaptcha(timeout = 7000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check(){
          if (window.grecaptcha && typeof window.grecaptcha.execute === 'function') return resolve(window.grecaptcha);
          if (Date.now() - start > timeout) return reject(new Error('grecaptcha timeout'));
          setTimeout(check, 150);
        })();
      });
    }

    async function run() {
      statusEl.textContent = 'Contacting reCAPTCHA…';
      try {
        await waitForGrecaptcha();
      } catch(e) {
        const attempts = incAttempts();
        statusEl.textContent = 'reCAPTCHA failed to load.';
        errEl.textContent = 'Unable to contact reCAPTCHA. Try again or use a different browser.';
        errEl.style.display = 'block';
        actionsEl.style.display = '';
        if (attempts >= MAX_ATTEMPTS) statusEl.textContent = 'Multiple failures — try later.';
        return;
      }

      try {
        // Execute v3 token
        window.grecaptcha.ready(() => {
          window.grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'homepage' })
            .then(token => {
              // Option: send token to backend for secure verification.
              // For static-only flow we store a session flag (not secure against manual replay).
              setVerified(token);
              clearAttempts();
              statusEl.textContent = 'Verified — redirecting to site…';
              setTimeout(()=> location.replace('/index.html'), 300);
            })
            .catch(err => {
              const attempts = incAttempts();
              statusEl.textContent = 'reCAPTCHA execution error.';
              errEl.textContent = 'Execution failed — please try again.';
              errEl.style.display = 'block';
              actionsEl.style.display = '';
              if (attempts >= MAX_ATTEMPTS) statusEl.textContent = 'Multiple failures — try from another network.';
            });
        });
      } catch(e) {
        const attempts = incAttempts();
        statusEl.textContent = 'Unexpected error during verification.';
        errEl.textContent = 'Please retry or try another browser.';
        errEl.style.display = 'block';
        actionsEl.style.display = '';
      }
    }

    tryBtn.addEventListener('click', ()=> {
      errEl.style.display = 'none';
      actionsEl.style.display = 'none';
      run();
    });

    // If already verified and fresh, go straight to index (no loop)
    try {
      const raw = sessionStorage.getItem(STORAGE_KEY);
      if (raw) {
        const obj = JSON.parse(raw);
        if (obj && (Date.now() - (obj.ts || 0)) < VERIFICATION_TTL_MS) {
          statusEl.textContent = 'Already verified — redirecting…';
          setTimeout(()=> location.replace('/index.html'), 300);
          return;
        }
      }
    } catch(e){ /* ignore parse errors and continue to verify */ }

    run();
  })();
  </script>
</body>
</html>
